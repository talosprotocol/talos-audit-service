#!/usr/bin/env bash
# Pre-commit hook for talos-audit-service
# Validates: version sync, lint, format, tests, and Docker build
set -euo pipefail

echo "ğŸ”„ Running pre-commit validations..."

# 1. Version sync
echo "ğŸ“¦ Syncing version..."
python scripts/version_sync.py
git add pyproject.toml

# 2. Lint check (with auto-fix)
echo "ğŸ” Running linter (ruff check)..."
ruff check --fix .

# 3. Format check (with auto-fix)
echo "âœ¨ Running formatter (ruff format)..."
ruff format .

# 4. Re-add any auto-fixed files
git add -u

# 5. Run tests
echo "ğŸ§ª Running tests..."
PYTHONPATH=. pytest -q --tb=short

# 6. Docker build validation
echo "ğŸ³ Validating Docker build..."
docker build -t talos-audit-service:pre-commit-check . --quiet

echo "âœ… All pre-commit checks passed!"
